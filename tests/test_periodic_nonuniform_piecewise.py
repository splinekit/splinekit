#---------------
import pytest

#---------------
from splinekit.interval import RR
from splinekit.interval import Empty
from splinekit.interval import Singleton
from splinekit.interval import Open
from splinekit.interval import OpenClosed
from splinekit.interval import Closed
from splinekit.interval import ClosedOpen

#---------------
from splinekit import PeriodicNonuniformPiecewise

#---------------
class TestPeriodicNonuniformPiecewise:

    #---------------
    def test_init_PeriodicNonuniformPiecewise (
        self
    ):
        known_nonuniform_pieces = [
            # [raises_exception, period, [Piece]]
            [
                False,
                1, [
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((0.0, 1.0)), 0)
                ]
            ],
            [
                False,
                2, [
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((0.0, 1.0)), 0),
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((1.0, 2.0)), 0)
                ],
            ],
            [
                False,
                2, [
                    PeriodicNonuniformPiecewise.Piece(Empty(), 0),
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((0.0, 0.5)), 0),
                    PeriodicNonuniformPiecewise.Piece(Empty(), 0),
                    PeriodicNonuniformPiecewise.Piece(Singleton(0.5), 0),
                    PeriodicNonuniformPiecewise.Piece(Empty(), 0),
                    PeriodicNonuniformPiecewise.Piece(Open((0.5, 2.0)), 0),
                    PeriodicNonuniformPiecewise.Piece(Empty(), 0)
                ],
            ],
            [
                False,
                2, [
                    PeriodicNonuniformPiecewise.Piece(Singleton(0.0), 0),
                    PeriodicNonuniformPiecewise.Piece(Open((0.0, 2.0)), 0)
                ],
            ],
            [
                False,
                1, [
                    PeriodicNonuniformPiecewise.Piece(Closed((0.0, 0.25)), 0),
                    PeriodicNonuniformPiecewise.Piece(Open((0.25, 1.0)), 0)
                ],
            ],
            [
                True,
                -1, [
                ]
            ],
            [
                True,
                0, [
                ]
            ],
            [
                True,
                1, [
                    PeriodicNonuniformPiecewise.Piece(Empty(), 0)
                ]
            ],
            [
                True,
                1, [
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((-0.5, 0.5)), 0)
                ]
            ],
            [
                True,
                float("inf"), [
                    PeriodicNonuniformPiecewise.Piece(RR(), 0)
                ]
            ],
            [
                True,
                1, [
                    PeriodicNonuniformPiecewise.Piece(Open((0.0, 1.0)), 0)
                ]
            ],
            [
                True,
                1, [
                    PeriodicNonuniformPiecewise.Piece(OpenClosed((0.0, 1.0)), 0)
                ]
            ],
            [
                True,
                1, [
                    PeriodicNonuniformPiecewise.Piece(Closed((0.0, 1.0)), 0)
                ]
            ],
            [
                True,
                2, [
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((0.0, 0.5)), 0),
                    PeriodicNonuniformPiecewise.Piece(Open((0.5, 2.0)), 1)
                ],
            ],
            [
                True,
                1, [
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((0.0, 0.5)), 0),
                    PeriodicNonuniformPiecewise.Piece(ClosedOpen((0.5, 2.0)), 0)
                ]
            ]
        ]
        for test in known_nonuniform_pieces:
            raises_exception = test[0]
            period = test[1]
            pieces = test[2]
            if raises_exception:
                with pytest.raises(ValueError):
                    _ = PeriodicNonuniformPiecewise(
                        pieces,
                        period = period
                    )
            else:
                _ = PeriodicNonuniformPiecewise(
                    pieces,
                    period = period
                )

    #---------------
    def test_item_at (
        self
    ):
        known_item_ats = [
            # [period, [ivls], [arguments], [idx]]
            [
                4,
                [ClosedOpen((0.,2.160500769596953)), ClosedOpen((2.160500769596953,2.953006946582886)), ClosedOpen((2.953006946582886,4))],
                [0, 3.9999999999999996, -4.440892098500626e-16, 2.160500769596953, 2.953006946582886, 4, 5.0111487752263555, -4.861483453421133, 8.899858288592089, 3.4582241062225876, -4.462962856291403, -7.986491409426486, 2.4193470658769805, 2.8750725978189067, -4.208780529683291, 8.319349419774362],
                [0, 2, 2, 1, 2, 0, 0, 2, 0, 2, 2, 0, 1, 1, 2, 0]
            ],
            [
                5,
                [Closed((0.,0.7361239940660191)), OpenClosed((0.7361239940660191,1.3430388612617916)), Open((1.3430388612617916,3.6602463102761593)), ClosedOpen((3.6602463102761593,3.8033399105750023)), Closed((3.8033399105750023,4.817389047114204)), Open((4.817389047114204,5))],
                [0, 4.999999999999999, -8.881784197001252e-16, 0.7361239940660191, 1.3430388612617916, 3.6602463102761593, 3.8033399105750023, 4.817389047114204, 5, 12.277936462117243, 9.233518372629316, 13.884922900383089, 14.519297310782246, 1.4650228072052773, 2.087309276427183, 2.349520987310253, -8.523456869053415, 7.691797997982017, 2.126719441606215],
                [0, 5, 5, 0, 1, 3, 4, 4, 0, 2, 4, 4, 4, 2, 2, 2, 2, 2, 2]
            ],
            [
                5,
                [ClosedOpen((0.,5))],
                [0, 4.999999999999999, -8.881784197001252e-16, 5, -1.8861405667293907, 8.594266399385972, -5.5192004139046205, 10.120090870203782, 10.724759812262805, -4.655063915590365, -8.318512143156683, -6.129890779191057, 6.11547856651071, 4.782111115684204],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ],
            [
                3,
                [Closed((0.,0.544981806328322)), OpenClosed((0.544981806328322,0.6747521082913734)), Open((0.6747521082913734,0.6774903724930783)), Closed((0.6774903724930783,0.7956031530923948)), Open((0.7956031530923948,1.0305552966036484)), ClosedOpen((1.0305552966036484,1.448808483153791)), Closed((1.448808483153791,1.4891180837484792)), Open((1.4891180837484792,2.2864790475605012)), Closed((2.2864790475605012,2.873189239101392)), Open((2.873189239101392,3))],
                [0, 2.9999999999999996, -4.440892098500626e-16, 0.544981806328322, 0.6747521082913734, 0.6774903724930783, 0.7956031530923948, 1.0305552966036484, 1.448808483153791, 1.4891180837484792, 2.2864790475605012, 2.873189239101392, 3, 3.325475792926027, -1.0868678401912848, -0.8984551081679206, -4.23153575222733, 8.944968006522508, -4.4616991009797, 5.225044777807025, -1.2001884483135297, 4.519125070149174, 5.7570487800812185],
                [0, 9, 9, 0, 1, 3, 3, 5, 6, 6, 8, 8, 0, 0, 7, 7, 7, 9, 7, 7, 7, 7, 8]
            ],
            [
                3,
                [Closed((0.,1.3811107730225418)), OpenClosed((1.3811107730225418,2.076367158831988)), Open((2.076367158831988,2.1452001422260647)), ClosedOpen((2.1452001422260647,3))],
                [0, 2.9999999999999996, -4.440892098500626e-16, 1.3811107730225418, 2.076367158831988, 2.1452001422260647, 3, 6.924133132268655, -5.52182213863982, 4.144106148116991, 7.234506799755843, 2.1335059613609517, 3.097346166187259, -5.726296951404426, 0.8439165166623861, 1.3481513508448404, -1.308327261222765],
                [0, 3, 3, 0, 1, 3, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1]
            ],
            [
                3,
                [Closed((0.,0.08325661318216238)), Open((0.08325661318216238,0.12399822099300128)), ClosedOpen((0.12399822099300128,0.13473617509808822)), ClosedOpen((0.13473617509808822,0.2605708930360575)), ClosedOpen((0.2605708930360575,1.4683413871442959)), ClosedOpen((1.4683413871442959,1.894742320543508)), ClosedOpen((1.894742320543508,2.1614479723006936)), Closed((2.1614479723006936,2.5658305496802254)), Open((2.5658305496802254,3))],
                [0, 2.9999999999999996, -4.440892098500626e-16, 0.08325661318216238, 0.12399822099300128, 0.13473617509808822, 0.2605708930360575, 1.4683413871442959, 1.894742320543508, 2.1614479723006936, 2.5658305496802254, 3, 8.202564281862294, 6.5319431683283335, 3.8003783491875662, -1.8699976640757412, 2.475052742019431, 8.325875399145074, 5.647126220114367, -2.4666359651083685, -0.7914984937801852, 6.901151916673123],
                [0, 8, 8, 0, 2, 3, 4, 5, 6, 7, 7, 0, 7, 4, 4, 4, 7, 7, 8, 4, 7, 4]
            ],
            [
                1,
                [Closed((0.,0.049866331834607536)), OpenClosed((0.049866331834607536,0.23182407122871362)), OpenClosed((0.23182407122871362,0.33084895651563095)), Open((0.33084895651563095,0.4319361727330471)), ClosedOpen((0.4319361727330471,0.4320254008861304)), Closed((0.4320254008861304,0.9786803387589187)), Open((0.9786803387589187,1))],
                [0, 0.9999999999999999, -1.1102230246251565e-16, 0.049866331834607536, 0.23182407122871362, 0.33084895651563095, 0.4319361727330471, 0.4320254008861304, 0.9786803387589187, 1, -1.3548367562589607, 1.2645630977500095, 2.5153101588607703, 2.8120014793999353, -0.8738557867766521, 1.804858055404735, 1.0673527640702514, -1.1523236063063174, -1.7234116471885623, -0.05729376819692811],
                [0, 6, 6, 0, 1, 2, 4, 5, 5, 0, 5, 2, 5, 5, 1, 5, 1, 5, 2, 5]
            ],
            [
                2,
                [Closed((0.,0.21775118288899353)), Open((0.21775118288899353,0.4307319728735246)), Closed((0.4307319728735246,0.6214803735194878)), OpenClosed((0.6214803735194878,0.6764991741953534)), OpenClosed((0.6764991741953534,0.6846856409454785)), OpenClosed((0.6846856409454785,1.3027515815512078)), Open((1.3027515815512078,1.5459598984931469)), ClosedOpen((1.5459598984931469,1.9082990397382518)), ClosedOpen((1.9082990397382518,1.9982397302952508)), ClosedOpen((1.9982397302952508,2))],
                [0, 1.9999999999999998, -2.220446049250313e-16, 0.21775118288899353, 0.4307319728735246, 0.6214803735194878, 0.6764991741953534, 0.6846856409454785, 1.3027515815512078, 1.5459598984931469, 1.9082990397382518, 1.9982397302952508, 2, 2.68232079299782, -2.92230641185634, 5.052764795480066, 4.6311820152243435, 1.7722548811248986, 4.690511471989919, 0.7390102158039538, 4.7032254120001085, 4.23547333988574, 4.592028806073147],
                [0, 9, 9, 0, 2, 2, 3, 4, 5, 7, 8, 9, 0, 4, 5, 5, 3, 7, 5, 5, 5, 1, 2]
            ],
            [
                2,
                [ClosedOpen((0.,1.0305314266426264)), ClosedOpen((1.0305314266426264,1.2619561313112562)), ClosedOpen((1.2619561313112562,1.5422054756416896)), Closed((1.5422054756416896,1.9416855617738018)), Open((1.9416855617738018,2))],
                [0, 1.9999999999999998, -2.220446049250313e-16, 1.0305314266426264, 1.2619561313112562, 1.5422054756416896, 1.9416855617738018, 2, 4.947223789035221, 0.37034135859134976, 1.8560758568215165, -1.381071552168581, 0.03690631576842485, 1.215366239825583, 4.727631825553668, -1.9393635561343157, -0.7424850662825642, -0.696157005208645],
                [0, 4, 4, 1, 2, 3, 3, 0, 0, 0, 3, 0, 0, 1, 0, 0, 1, 2]
            ],
            [
                4,
                [ClosedOpen((0.,0.6084958286614199)), Closed((0.6084958286614199,0.737268207011784)), Open((0.737268207011784,2.7935822816311457)), ClosedOpen((2.7935822816311457,4))],
                [0, 3.9999999999999996, -4.440892098500626e-16, 0.6084958286614199, 0.737268207011784, 2.7935822816311457, 4, 11.305402693461566, 8.726058515064945, 3.0863925303388022, 1.7764872228179023, 0.5341442410320667, 2.5239431198481004, 5.4685434930683545, 6.750646972017645, 0.1368371213754287, -1.5362913471170998],
                [0, 3, 3, 1, 1, 3, 0, 3, 1, 3, 2, 0, 2, 2, 2, 0, 2]
            ],
            [
                1,
                [Closed((0.,0.16731222634910248)), Open((0.16731222634910248,0.19147151314076583)), Closed((0.19147151314076583,0.374115828937998)), OpenClosed((0.374115828937998,0.4444792124496939)), Open((0.4444792124496939,0.5301604302534912)), Closed((0.5301604302534912,0.6503275257816918)), OpenClosed((0.6503275257816918,0.709514387837054)), Open((0.709514387837054,0.8408338003256106)), ClosedOpen((0.8408338003256106,0.8791273746880612)), ClosedOpen((0.8791273746880612,1))],
                [0, 0.9999999999999999, -1.1102230246251565e-16, 0.16731222634910248, 0.19147151314076583, 0.374115828937998, 0.4444792124496939, 0.5301604302534912, 0.6503275257816918, 0.709514387837054, 0.8408338003256106, 0.8791273746880612, 1, 2.15313850522376, 0.18325391822224435, -0.5264408389529556, -0.09637381989885996, 0.2438476142456476, 2.522628384430024, 2.1518933062218153, -1.037392061889007, -1.9886639951590095, -1.2500000537521976],
                [0, 9, 9, 0, 2, 2, 3, 5, 5, 6, 8, 9, 0, 0, 1, 4, 9, 2, 4, 0, 9, 0, 7]
            ],
            [
                1,
                [ClosedOpen((0.,0.025068101370909313)), ClosedOpen((0.025068101370909313,0.14261132633644236)), Closed((0.14261132633644236,0.39457203142162167)), Open((0.39457203142162167,0.5648227803487056)), ClosedOpen((0.5648227803487056,0.9762985356877445)), ClosedOpen((0.9762985356877445,1))],
                [0, 0.9999999999999999, -1.1102230246251565e-16, 0.025068101370909313, 0.14261132633644236, 0.39457203142162167, 0.5648227803487056, 0.9762985356877445, 1, 2.669514496262115, -0.011475055070961249, 1.3704819644618023, 0.7685902184991873, 1.077310238342329, -1.5143163055182878, 1.5999275930254249, -1.3868034328215233, 1.8017178462126433, 0.7971411908999277],
                [0, 5, 5, 1, 2, 2, 4, 5, 0, 4, 5, 2, 4, 1, 3, 4, 4, 4, 4]
            ],
            [
                2,
                [ClosedOpen((0.,0.050643780722472886)), ClosedOpen((0.050643780722472886,0.5948524439970502)), ClosedOpen((0.5948524439970502,2))],
                [0, 1.9999999999999998, -2.220446049250313e-16, 0.050643780722472886, 0.5948524439970502, 2, -1.1502017186815259, -0.8548012011654347, -3.387013216640694, -0.13482674330797728, 3.7300567199479397, -0.9861797503976897, 1.6295146053571798, 0.8516663864301468, 0.30922216821256976, 5.95309344267453],
                [0, 2, 2, 1, 2, 0, 2, 2, 2, 2, 2, 2, 2, 2, 1, 2]
            ],
            [
                5,
                [Closed((0.,0.29110749807306435)), OpenClosed((0.29110749807306435,3.1805603409118244)), Open((3.1805603409118244,5))],
                [0, 4.999999999999999, -8.881784197001252e-16, 0.29110749807306435, 3.1805603409118244, 5, -3.5405066896768944, 10.938600341493007, -1.532741420531677, 12.833419529799064, 14.495110953168641, -6.378079337526684, 6.786606144724741, 13.686292702583572, 7.242793975304571, 3.555152557970712],
                [0, 2, 2, 0, 1, 0, 1, 1, 2, 1, 2, 2, 1, 2, 1, 2]
            ],
            [
                2,
                [ClosedOpen((0.,0.22061184259581212)), ClosedOpen((0.22061184259581212,0.634046324341031)), Closed((0.634046324341031,1.4098400971233684)), OpenClosed((1.4098400971233684,1.7018673194546738)), OpenClosed((1.7018673194546738,1.8591716269416398)), Open((1.8591716269416398,2))],
                [0, 1.9999999999999998, -2.220446049250313e-16, 0.22061184259581212, 0.634046324341031, 1.4098400971233684, 1.7018673194546738, 1.8591716269416398, 2, 5.158926116720552, -1.2827537172270662, 0.5463642250872471, -3.6877414557939567, 3.2722058194605466, 0.8129685811075951, -1.6731884873891887, -2.456988568323398, 4.123235215314699, 1.115763731299714],
                [0, 5, 5, 1, 2, 2, 3, 4, 0, 2, 2, 1, 1, 2, 2, 1, 3, 0, 2]
            ],
            [
                4,
                [ClosedOpen((0.,0.2941502114087866)), ClosedOpen((0.2941502114087866,0.6819696654421774)), ClosedOpen((0.6819696654421774,4))],
                [0, 3.9999999999999996, -4.440892098500626e-16, 0.2941502114087866, 0.6819696654421774, 4, -7.824654800172068, 6.23852775015602, 7.6658699134833945, 4.180988560975146, -5.922281525507269, -6.694864544137961, -0.9501804643749319, 7.934588245827266, -5.896712205900425, -5.2473491216164065],
                [0, 2, 2, 1, 2, 0, 0, 2, 2, 0, 2, 2, 2, 2, 2, 2]
            ],
            [
                1,
                [ClosedOpen((0.,0.07490314762767158)), Closed((0.07490314762767158,0.222176090203831)), Open((0.222176090203831,0.3667480379825907)), ClosedOpen((0.3667480379825907,0.8788955343275155)), ClosedOpen((0.8788955343275155,1))],
                [0, 0.9999999999999999, -1.1102230246251565e-16, 0.07490314762767158, 0.222176090203831, 0.3667480379825907, 0.8788955343275155, 1, 2.020466318171003, 0.322854966213278, 0.10327579428307154, -0.47272767860867027, 1.0525983766189146, 2.6526705785830504, 1.0555728331775456, 2.492891653630997, -1.9025121698117813, 2.6805717082581055],
                [0, 4, 4, 1, 1, 3, 4, 0, 0, 2, 1, 3, 0, 3, 0, 3, 1, 3]
            ],
            [
                2,
                [Closed((0.,0.6509334307999524)), Open((0.6509334307999524,0.6814881895129288)), ClosedOpen((0.6814881895129288,1.1889402624583743)), Closed((1.1889402624583743,1.5620719507283995)), OpenClosed((1.5620719507283995,1.8076560098607697)), Open((1.8076560098607697,2))],
                [0, 1.9999999999999998, -2.220446049250313e-16, 0.6509334307999524, 0.6814881895129288, 1.1889402624583743, 1.5620719507283995, 1.8076560098607697, 2, -2.912796057032395, 2.8801556764309435, 0.931259899251843, -2.592552535641176, 3.0342557297172803, -3.5229657762912945, 0.7022142987923554, 5.587517874283192, 2.3549219079627672, 2.9684034342712287],
                [0, 5, 5, 0, 2, 3, 3, 4, 0, 2, 2, 2, 3, 2, 0, 2, 4, 0, 2]
            ],
            [
                5,
                [ClosedOpen((0.,2.1976760654433747)), Closed((2.1976760654433747,3.087206985569231)), Open((3.087206985569231,3.83479283307853)), ClosedOpen((3.83479283307853,5))],
                [0, 4.999999999999999, -8.881784197001252e-16, 2.1976760654433747, 3.087206985569231, 3.83479283307853, 5, -2.315822730675645, 7.332533626277846, 5.185868974714534, 5.792819147169651, 4.19525370622906, 14.94536117454112, -5.474149354795779, 5.472095497019622, 7.522601717011144, 0.04820716679842296],
                [0, 3, 3, 1, 1, 3, 0, 1, 1, 0, 0, 3, 3, 3, 0, 1, 0]
            ],
            [
                5,
                [Closed((0.,0.21699521273936817)), Open((0.21699521273936817,0.24584341387674402)), Closed((0.24584341387674402,0.5397559743620395)), Open((0.5397559743620395,3.497484470651168)), ClosedOpen((3.497484470651168,5))],
                [0, 4.999999999999999, -8.881784197001252e-16, 0.21699521273936817, 0.24584341387674402, 0.5397559743620395, 3.497484470651168, 5, 3.169495951428234, -6.633680661061066, 7.990178417039976, -1.7216263955539068, -2.493927653538488, 10.050674920177263, 6.750934005584389, 13.63605177311008, 1.4008027621246844, -9.727954785585549],
                [0, 4, 4, 0, 2, 2, 4, 0, 3, 3, 3, 3, 3, 0, 3, 4, 3, 2]
            ]
        ]
        for test in known_item_ats:
            period = test[0]
            ivls = test[1]
            arguments = test[2]
            idx = test[3]
            pieces = [
                PeriodicNonuniformPiecewise.Piece(ivl, k)
                for (k, ivl) in enumerate(ivls)
            ]
            piecewise = PeriodicNonuniformPiecewise(
                pieces,
                period = period
            )
            for (k, x) in enumerate(arguments):
                print("k = ", k, ", x = ", x, ", idx[k] = ", idx[k], ", piecewise.item_at(x)= ", piecewise.item_at(x))
                assert idx[k] == piecewise.item_at(x)

